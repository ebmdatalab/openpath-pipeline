# Data source anonymisation

This folder contains code for anonymisation of raw source data.

Given input data in a variety of row-oriented formats, container one
month of data per file, convert it such that all raw test result
values are aggregated to "within range", "under range", "over range",
or a variety of error codes indicating that the range could not be
computed (for example, because we currently don't consider children
for reference ranges; or because a value was non-numeric).

To run the cornwall processor, for example:

    python runner.py cornwall north_devon/sample.xlsx

# Making a data source

A data source is a package within this directory (e.g. `data_sources/north_devon/`) that contains a file `anonymiser_config.py`.  This file must contain:

* `LAB_CODE`: a string with a unique token for this source
* `REFERENCE_RANGES`: path to a CSV of reference ranges (see below)
* `INPUT_FILES`: an iterable returning input filenames
* `row_iterator(filename)`: a function that yields rows of dictionaries from a source pointed to by `filename`
* `drop_unwanted_data(row_anonymiser)`: a function that raises `StopProcessing` if the row passed in should be skipped (for example, invalid or dummy data)
* `normalise_data(row_anonymiser)`: a function that normalises an input row to an output row with the fields `month`, `test_code`, `test_result`, `practice_id`, `age`, `sex`, `direction`.

Currently we only process data for adults (18 years and older), so at the point age is calculated, rows should be dropped for under-18s (by raising `StopIteration`).

For labs that integrate reference range values into the result data file, `REFERENCE_RANGES` should be an empty string, and you will also want to implement

* `convert_to_result`: a function which takes an object which has a `row` attribute which is a dict corresponding to the output row generated by `normallise_data`, and sets a `result_category` key which is one of the preset "error codes" (`WITHIN_RANGE`, `ERR_INVALID_REF_RANGE`, etc). See the cambridge data source for an example.


## Reference Range CSVs

For labs which provide reference ranges in a file separate from the data, we require CSV files which are generated in a normalised form from source files stored in `<data_source>/metadata/`.  They must contain the fields `test`, `min_adult_age`, `max_adult_age`, `low_F`, `low_M`, `high_F`, `high_M`.

A test may appear several times for different age ranges. We use `120` as the ceiling for adult ranges.

By convention, these CSVs are generated by a python file called `generate_ranges.py`, within each source folder.  See `north_devon/generate_ranges.py` for an example.

The presence of a suitably-formatted file, referenced by the `REFERENCE_RANGES` variable, means "error codes" can be calculated automatically.
